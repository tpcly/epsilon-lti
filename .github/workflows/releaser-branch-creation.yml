name: Release Pull Request
on:
    push:
        branches:
            - 'release/**'
            - 'release/**-Beta.*'
env:
    CURRENT_BRANCH: ${{ github.ref }}
    APP_VERSION: ''
jobs:
    define-version:
#        if: github.event.created
        permissions: write-all
        runs-on: ubuntu-latest
        steps:
            -   name: Extract branch name
                shell: bash
                run: echo "APP_VERSION=${GITHUB_REF##*/}" >> $GITHUB_ENV
            -   name: Checkout repository
                uses: actions/checkout@v3
            -   name: Setup node
                uses: actions/setup-node@v4
                with:
                    node-version: 20
            -   name: Set version
                run: |
                    cd Epsilon.Host.Frontend
                    npm version ${{ env.APP_VERSION }} --git-tag-version false
            -   name: Commit changes
                uses: EndBug/add-and-commit@v9
                with:
                    default_author: github_actions
                    message: Bump version package.json to ${{ env.APP_VERSION }}
                    add: Epsilon.Host.Frontend/package.json
                    push: origin HEAD:release/${{env.APP_VERSION}}
    pull-request-creation:
        needs: [ define-version ]
        permissions:
            contents: write
            pull-requests: write
        runs-on: ubuntu-latest
        steps:
            -   name: Checkout repository
                uses: actions/checkout@v3
            -   name: Extract branch name
                shell: bash
                run: echo "APP_VERSION=${GITHUB_REF##*/}" >> $GITHUB_ENV
            -   name: create pull request
                run: gh pr create -B main -H ${{ env.CURRENT_BRANCH }} -d --title '${{ env.APP_VERSION }}' --body 'This is an automated pull request to update the version of Epsilon to ${{ env.APP_VERSION }}.
                    The version is updated in the package.json file.'
                env:
                    GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    