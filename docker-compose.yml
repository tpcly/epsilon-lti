version: "3.3"
services:
    traefik:
        image: "traefik:v2.10"
        container_name: "Epsilon-Traefik"
        command:
            - "--log.level=DEBUG"
            - "--api.insecure=true"
            - "--providers.docker=true"
            - "--providers.docker.exposedbydefault=false"
            - "--entrypoints.web.address=:80"
            - "--entrypoints.websecure.address=:443"
            - "--certificatesresolvers.epsiloncertresolver.acme.httpchallenge=true"
            - "--certificatesresolvers.epsiloncertresolver.acme.httpchallenge.entrypoint=web"
            - "--certificatesresolvers.epsiloncertresolver.acme.caserver=https://acme-staging-v02.api.letsencrypt.org/directory"
            - "--certificatesresolvers.epsiloncertresolver.acme.email=451394@student.fontys.nl"
            - "--certificatesresolvers.epsiloncertresolver.acme.storage=/letsencrypt/acme.json"
        ports:
            - "80:80"
            - "443:443"
            - "8080:8080"
        volumes:
            - "/var/run/docker.sock:/var/run/docker.sock:ro"

    frontend:
        container_name: Epsilon-Frontend
        build:
            context: ./Epsilon.Host.Frontend
            dockerfile: ./Dockerfile
        labels:
            - "traefik.enable=true"
            - "traefik.http.routers.frontend.rule=PathPrefix(`/`)"
            - "traefik.http.routers.frontend.entrypoints=web"
            #- "traefik.http.routers.frontend.entrypoints=websecure"
            # - "traefik.http.routers.frontend.rule=Host(`epsilon.deltafhict.nl`)"
            # - "traefik.http.routers.frontend.tls=true"
            # - "traefik.http.routers.frontend.tls.certresolver=epsiloncertresolver"

    whoami:
        image: "traefik/whoami"
        container_name: "simple-service"
        labels:
            - "traefik.enable=true"
            - "traefik.http.routers.whoami.rule=PathPrefix(`/whoami`)"
            - "traefik.http.routers.whoami.entrypoints=web"

    api:
        container_name: Epsilon-API
        build:
            context: .
            dockerfile: ./Epsilon.Host.WebApi/Dockerfile
        labels:
            - "traefik.enable=true"
            - "traefik.http.routers.api.rule=PathPrefix(`/backend`)"
            - "traefik.http.routers.api.entrypoints=web"
            # - "traefik.http.routers.api.rule=Host(`epsilon.deltafhict.nl`)"
            # - "traefik.http.routers.api.tls=true"
            # - "traefik.http.routers.api.tls.certresolver=epsiloncertresolver"
        environment:
            - ASPNETCORE_ENVIRONMENT=Development
            - ASPNETCORE_URLS=http://+:80;
    db:
        container_name: Epsilon-DB
        image: mariadb:10
        environment:
            MARIADB_ROOT_PASSWORD: not_toor
            MARIADB_DATABASE: epsilon
        ports:
            - 3306:3306
        volumes:
            - /var/lib/mysql:/data
